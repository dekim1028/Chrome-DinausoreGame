<!DOCTYPE html>

<html>

<head>
    <title>공룡 게임</title>

    <style>
        body {
            background-color: #000000;
            margin: 0px;
        }

        canvas {
            background-color: #ffffff;
        }
    </style>

</head>



<body>
    <canvas id="canvas" width="1600" height="770"></canvas>
</body>

<script>

    let canvas;
    let canvasCtx;

    let canvasBuffer;
    let bufferCtx;

    const playerUnit = {x: 300, y: 400}; // 공룡 시작 위치
    const threadSpeed = 10;     //Gap of Thread
    let dinausoreImg;
    
    let gameLoopThread;  //draw view Thread ID
    let walkLoopThread = null; //walk Thread ID

    window.onload = function(){
        init();
    }

    function init() {

        canvas = document.getElementById("canvas");
        canvasCtx = canvas.getContext("2d");
        canvasBuffer = document.createElement("canvas");
        canvasBuffer.width = canvas.width;
        canvasBuffer.height = canvas.height;
        bufferCtx = canvasBuffer.getContext("2d");

        document.onkeydown=getKeyDown;

        setImage();

        gameLoopThread = setInterval(gameLoop, threadSpeed);

    }


    function setImage() {
        dinausoreImg = new Image();
        dinausoreImg.src = "./image/DNS_3.png";
    }

    function getKeyDown(e) {

        if(e.which == 32 && playerUnit.y == "400"){ //바닥에 있을 떄만 점프
            if(walkLoopThread != null){
                clearInterval(walkLoopThread);
            }

            dinausoreImg.src="./image/DNS_3.png";

            var timer = setInterval(function(){
                if(playerUnit.y>150){
                    playerUnit.y-=10;
                }else{
                    clearInterval(timer);
                }
            },10);

            setTimeout(function(){
                timer = setInterval(function(){
                    if(playerUnit.y<400){
                        playerUnit.y+=10;
                    }else{
                        clearInterval(timer);
                    }
                },10);
            },400);
            

        }  
    }

    function gameLoop() {
        displayAll();
    }

    function move(){
            let pos = 0;
            const DNSArr = ["./image/DNS_1.png","./image/DNS_2.png"];
            let intervalID = setInterval(function(){
                dinausoreImg.src=DNSArr[pos];
                pos == 0?pos=1:pos=0;
            },100);

            return intervalID;
    }

    function displayAll() {

        bufferCtx.fillStyle = "#ffffff";
        bufferCtx.fillRect(0, 0, canvas.width, canvas.height);
        bufferCtx.drawImage(dinausoreImg, playerUnit.x, playerUnit.y , 130, 130);

        setInterval(displayHurdle(),800);

        canvasCtx.drawImage(canvasBuffer, 0, 0);
    }

    let hurdleImgStack = [];
    function displayHurdle(){
        if(hurdleImgStack.length==0){
            let hurdleImg = new Image();
            const random = parseInt(Math.random() * 3 + 1);
            imgSrc = `./image/hurdle_${random}.png`;
            hurdleImg.src = imgSrc;
            hurdleImgStack.push({"hurdleImg":hurdleImg, "x": 1500, "y": 450, "imgX":30*random, "imgY":80});
        }

        const loop = hurdleImgStack.length;
        for(var i=0;i<loop;i++){
            if(hurdleImgStack[i].x==0){
                hurdleImgStack.shift();
                continue;
            }
            hurdleImgStack[i].x -= 6;
            bufferCtx.drawImage(hurdleImgStack[i].hurdleImg, hurdleImgStack[i].x, hurdleImgStack[i].y, hurdleImgStack[i].imgX,hurdleImgStack[i].imgY);
        }

       
    }

</script>